name: Flipside AI + Twitter Automation (AI-Generated Prompts)

on:
  schedule:
    # Run twice daily at 9 AM and 6 PM UTC
    - cron: '0 9 * * *'
    - cron: '0 18 * * *'
  workflow_dispatch: # Allow manual trigger
    # Note: With AI-generated prompt system, the AI automatically selects analysis topics
    # No input parameters needed - the AI will choose based on current data and avoid recent analyses

jobs:
  analyze:
    runs-on: ubuntu-latest
    environment: twitter_analyst
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: Create virtual environment
      run: python -m venv venv
      
    - name: Activate virtual environment and install dependencies
      run: |
        source venv/bin/activate
        pip install --upgrade pip
        pip install -r requirements.txt
        
    - name: Set up Chrome for undetected-chromedriver
      uses: browser-actions/setup-chrome@v1
      with:
        chrome-version: '142'
      
    - name: Create cookies file
      run: |
        echo "${{ secrets.FLIPSIDE_COOKIES }}" > flipside_cookies.txt
        
    - name: Run Full Flipside AI + Twitter Workflow
      env:
        # Twitter API credentials
        TWITTER_BEARER_TOKEN: ${{ secrets.TWITTER_BEARER_TOKEN }}
        TWITTER_CONSUMER_KEY: ${{ secrets.TWITTER_CONSUMER_KEY }}
        TWITTER_CONSUMER_SECRET: ${{ secrets.TWITTER_CONSUMER_SECRET }}
        TWITTER_ACCESS_TOKEN: ${{ secrets.TWITTER_ACCESS_TOKEN }}
        TWITTER_ACCESS_TOKEN_SECRET: ${{ secrets.TWITTER_ACCESS_TOKEN_SECRET }}
        # Flipside login credentials (for CI fallback)
        FLIPSIDE_EMAIL: ${{ secrets.FLIPSIDE_EMAIL }}
        FLIPSIDE_PASSWORD: ${{ secrets.FLIPSIDE_PASSWORD }}
        # Analysis settings
        DEBUG_MODE: 'false'
        HEADLESS_MODE: 'true'
        CHROME_HEADLESS: 'true'
      run: |
        source venv/bin/activate
        
        # With AI-generated prompt system, no prompt parameter needed
        # The AI will automatically select an analysis topic based on current data
        # and avoid repeating recent analyses (tracks last 32 prompts)
        echo "ðŸ¤– Running with AI-generated prompt system..."
        echo "   The AI will select an analysis topic automatically"
        echo "   Recent analyses are tracked to avoid repetition"
        python main_workflow.py
        
    - name: Upload screenshots as artifacts
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: analysis-screenshots-${{ github.run_number }}
        path: |
          screenshots/
          charts/
        retention-days: 30
        
    - name: Upload logs as artifacts
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: analysis-logs-${{ github.run_number }}
        path: logs/
        retention-days: 7
        
    - name: Upload analysis results as artifacts
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: analysis-results-${{ github.run_number }}
        path: |
          logs/analysis_*.json
          logs/twitter_posts_*.jsonl
        retention-days: 30
        
    - name: Create analysis summary
      if: always()
      run: |
        echo "## ðŸ¤– Flipside AI + Twitter Automation Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Run Number:** ${{ github.run_number }}" >> $GITHUB_STEP_SUMMARY
        echo "**Timestamp:** $(date)" >> $GITHUB_STEP_SUMMARY
        echo "**Trigger:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
        
        # Show AI-generated prompt details
        echo "**Prompt System:** AI-Generated (AI selects topic automatically)" >> $GITHUB_STEP_SUMMARY
        
        # Try to get the AI-generated condensed prompt from logs
        if [ -d "logs" ]; then
          LATEST_ANALYSIS=$(find logs/ -name "analysis_*.json" -type f -exec ls -t {} + | head -1)
          if [ -n "$LATEST_ANALYSIS" ]; then
            CONDENSED_PROMPT=$(grep -o '"condensed_prompt": "[^"]*"' "$LATEST_ANALYSIS" | cut -d'"' -f4 || echo "")
            if [ -n "$CONDENSED_PROMPT" ]; then
              echo "**AI-Generated Topic:** \`$CONDENSED_PROMPT\`" >> $GITHUB_STEP_SUMMARY
            fi
          fi
          
          # Also check recent prompts file
          if [ -f "prompts/recent_prompts.json" ]; then
            RECENT_COUNT=$(jq 'length' prompts/recent_prompts.json 2>/dev/null || echo "0")
            echo "**Recent Analyses Tracked:** $RECENT_COUNT" >> $GITHUB_STEP_SUMMARY
          fi
        fi
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ -d "logs" ]; then
          echo "### ðŸ“ Generated Files" >> $GITHUB_STEP_SUMMARY
          echo "- Screenshots: \`screenshots/\`" >> $GITHUB_STEP_SUMMARY
          echo "- Charts: \`charts/\`" >> $GITHUB_STEP_SUMMARY
          echo "- Analysis Logs: \`logs/analysis_*.json\`" >> $GITHUB_STEP_SUMMARY
          echo "- Twitter Posts: \`logs/twitter_posts_*.jsonl\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Count files
          SCREENSHOT_COUNT=$(find screenshots/ -name "*.png" 2>/dev/null | wc -l || echo "0")
          CHART_COUNT=$(find charts/ -name "*.png" 2>/dev/null | wc -l || echo "0")
          LOG_COUNT=$(find logs/ -name "analysis_*.json" 2>/dev/null | wc -l || echo "0")
          TWITTER_COUNT=$(find logs/ -name "twitter_posts_*.jsonl" 2>/dev/null | wc -l || echo "0")
          
          echo "### ðŸ“ˆ Statistics" >> $GITHUB_STEP_SUMMARY
          echo "- Screenshots captured: $SCREENSHOT_COUNT" >> $GITHUB_STEP_SUMMARY
          echo "- Charts generated: $CHART_COUNT" >> $GITHUB_STEP_SUMMARY
          echo "- Analysis logs: $LOG_COUNT" >> $GITHUB_STEP_SUMMARY
          echo "- Twitter posts: $TWITTER_COUNT" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Show latest Twitter post if available
          LATEST_TWITTER=$(find logs/ -name "twitter_posts_*.jsonl" -exec tail -1 {} \; 2>/dev/null | head -1)
          if [ -n "$LATEST_TWITTER" ]; then
            echo "### ðŸ¦ Latest Twitter Post" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`json" >> $GITHUB_STEP_SUMMARY
            echo "$LATEST_TWITTER" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          fi
        fi
